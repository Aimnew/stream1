name: Auto Deploy to Streamlit Cloud

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Test application
      run: |
        python -c "import streamlit; import pandas; import plotly"
        echo "âœ… All dependencies installed successfully"
        
    - name: Check data files
      run: |
        echo "ğŸ“ Checking data files..."
        ls -la *.csv
        echo "âœ… Data files found"
        
    - name: Deploy notification
      run: |
        echo "ğŸš€ Code changes detected!"
        echo "ğŸ“Š Application will be automatically deployed to Streamlit Cloud"
        echo "ğŸŒ Check your app at: https://rfpopulate.streamlit.app"
        echo "â±ï¸ Deployment usually takes 2-5 minutes"
        
    - name: Wait for deployment
      run: |
        echo "â³ Waiting for deployment to complete..."
        sleep 30
        
    - name: Health check after deployment
      run: |
        echo "ğŸ” Checking if deployment was successful..."
        response=$(curl -s -o /dev/null -w "%{http_code}" https://rfpopulate.streamlit.app)
        if [ "$response" -eq 200 ]; then
          echo "âœ… Deployment successful! App is responding."
        else
          echo "âš ï¸ App might still be deploying. Check manually in a few minutes."
        fi 